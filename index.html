<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>國立清華大學114學年度新生註冊時程</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --color-primary: #53267F;
            --color-text: #333;
            --color-background: #f8f9fa;
            --color-light-gray: #e9ecef;
            --color-white: #fff;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.05);
            --shadow-md: 0 4px 8px rgba(0,0,0,0.1);
            --border-radius: 4px;
            --event-bar-height: 22px;
            --event-bar-v-margin: 2px;

            --cat-registration: #007bff;
            --cat-academic: #28a745;
            --cat-housing: #fd7e14;
            --cat-financial: #dc3545;
            --cat-activity: #17a2b8;
        }

        body {
            font-family: system-ui, -apple-system, "Noto Sans TC", sans-serif;
            background-color: var(--color-background);
            color: var(--color-text);
            margin: 0;
            padding: 1rem;
            line-height: 1.6;
        }

        #app {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem;
        }

        header {
            text-align: center;
            padding: 1rem 0;
            border-bottom: 1px solid var(--color-light-gray);
            margin-bottom: 2rem;
        }

        header h1 {
            color: var(--color-primary);
            font-size: 1.8rem;
            margin: 0;
        }

        main {
            display: grid;
            grid-template-columns: 1fr;
            gap: 2rem;
        }

        @media (min-width: 992px) {
            main {
                grid-template-columns: 300px 1fr;
            }
        }

        .overview-section, .calendar-section {
            background: var(--color-white);
            padding: 1.5rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-sm);
        }

        .calendar-section {
            position: relative;
        }

        h2 {
            font-size: 1.5rem;
            margin-top: 0;
            color: var(--color-primary);
        }

        /* Overview Section */
        .overview-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .overview-item {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
            cursor: pointer;
            transition: opacity 0.3s ease;
        }
        
        .overview-item.done {
            opacity: 0.5;
        }
        
        .overview-item.done .item-title {
            text-decoration: line-through;
        }

        .overview-item input[type="checkbox"] {
            margin-right: 0.75rem;
            min-width: 16px;
            height: 16px;
        }

        .item-title {
            flex-grow: 1;
            font-size: 0.95rem;
        }

        .category-tag {
            padding: 0.2em 0.6em;
            border-radius: var(--border-radius);
            color: var(--color-white);
            font-size: 0.75rem;
            white-space: nowrap;
        }

        /* Calendar Section */
        .calendar-container {
            position: relative;
        }

        .calendar-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .calendar-controls button {
            background: none;
            border: 1px solid var(--color-light-gray);
            border-radius: var(--border-radius);
            padding: 0.5rem 1rem;
            cursor: pointer;
            font-size: 1.2rem;
            transition: background-color 0.2s ease;
        }

        .calendar-controls button:hover {
            background-color: var(--color-light-gray);
        }

        #current-month-year {
            font-size: 1.4rem;
            font-weight: bold;
            color: var(--color-primary);
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            grid-auto-rows: 1fr;
            gap: 1px;
            position: relative;
            background-color: var(--color-light-gray);
            border: 1px solid var(--color-light-gray);
        }

        .calendar-header {
            text-align: center;
            font-weight: bold;
            color: var(--color-primary);
            padding: 0.5rem 0;
            background-color: var(--color-white);
        }

        .calendar-day {
            background-color: #fff;
            position: relative;
            padding: 4px;
            padding-top: 30px;
            min-height: 120px;
            box-sizing: border-box;
        }
        
        .calendar-day.other-month {
            background-color: #fdfdff;
        }

        .calendar-day.other-month .day-number {
            opacity: 0.4;
        }

        .day-number {
            position: absolute;
            top: 5px;
            right: 5px;
            font-size: 0.85rem;
            z-index: 2;
        }
        
        .calendar-day.today .day-number {
            background-color: var(--color-primary);
            color: var(--color-white);
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
        }

        #event-layer {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
        }

        .event-bar {
            font-size: 0.75rem;
            padding: 0 8px;
            color: white;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            cursor: pointer;
            position: absolute;
            height: var(--event-bar-height);
            line-height: var(--event-bar-height);
            box-sizing: border-box;
            pointer-events: auto;
        }

        .event-bar.start-cap {
            border-top-left-radius: var(--border-radius);
            border-bottom-left-radius: var(--border-radius);
        }

        .event-bar.end-cap {
            border-top-right-radius: var(--border-radius);
            border-bottom-right-radius: var(--border-radius);
        }
        
        .event-bar:hover {
            opacity: 0.8;
            z-index: 3;
        }
        
        .event-bar.done {
            opacity: 0.5;
            text-decoration: line-through;
        }

        .calendar-legend {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 1rem;
            margin-top: 1.5rem;
            padding-top: 1rem;
            border-top: 1px solid var(--color-light-gray);
        }

        .legend-item {
            display: flex;
            align-items: center;
            font-size: 0.85rem;
        }

        .legend-color-box {
            width: 16px;
            height: 16px;
            border-radius: var(--border-radius);
            margin-right: 0.5rem;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
            z-index: 1000;
        }

        .modal-overlay.visible {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: var(--color-white);
            padding: 2rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-md);
            width: 90%;
            max-width: 600px;
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }
        
        .modal-overlay.visible .modal-content {
            transform: scale(1);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--color-light-gray);
            padding-bottom: 1rem;
            margin-bottom: 1rem;
        }

        .modal-header h3 {
            margin: 0;
            font-size: 1.5rem;
            color: var(--color-primary);
        }

        .modal-close-btn {
            background: none;
            border: none;
            font-size: 2rem;
            cursor: pointer;
            line-height: 1;
        }
        
        .modal-body p {
            margin: 0 0 1rem 0;
        }
        
        .modal-body strong {
            color: var(--color-primary);
            margin-right: 0.5rem;
        }

        .modal-body a {
            color: var(--color-primary);
            text-decoration: none;
            font-weight: 500;
        }

        .modal-body a:hover {
            text-decoration: underline;
        }

        /* Responsive */
        @media (max-width: 768px) {
            body { padding: 0.5rem; }
            #app { padding: 0.5rem; }
            header h1 { font-size: 1.5rem; }
            h2 { font-size: 1.3rem; }
            .event-bar { font-size: 0.7rem; height: 20px; line-height: 20px; }
            .calendar-header { font-size: 0.8rem; }
            .modal-content { padding: 1.5rem; }
            .modal-header h3 { font-size: 1.3rem; }
        }
        
        @media (max-width: 480px) {
            main { grid-template-columns: 1fr; }
            .calendar-grid { gap: 1px; }
            .calendar-day { min-height: 80px; padding-top: 25px; }
            .day-number { font-size: 0.75rem; }
            .event-bar { display: none; } /* Hide event text on very small screens */
            .dots-container { 
                position: absolute;
                bottom: 4px;
                left: 0;
                right: 0;
                text-align: center;
            }
            .event-dot { /* Show a dot instead */
                display: inline-block;
                width: 8px;
                height: 8px;
                border-radius: 50%;
                margin: 0 1px;
            }
        }

    </style>
</head>
<body>

    <div id="app"></div>

    <script>
        const eventData = [
          { "id": "residential-college-apply-1", "title": "申請清華書院(第一階段)", "startDate": "2025-05-12T12:00:00", "endDate": "2025-07-10T12:00:00", "category": "Housing", "targetAudience": "全體大一新生", "details": "有意申請厚德、載物、天下書院者，需至[書院網站](https://www.nthu.edu.tw/)報名。", "responsibleUnit": "清華書院 / 分機:62559" },
          { "id": "reserve-admission", "title": "申請保留入學資格", "startDate": "2025-07-01T00:00:00", "endDate": "2025-08-29T23:59:59", "category": "Academic", "targetAudience": "因重病、懷孕等特殊事故無法當學年入學之新生。", "details": "需檢具有關證明於7月1日至8月29日止向教務處申請保留入學資格。", "responsibleUnit": "註冊組" },
          { "id": "residential-college-register-1", "title": "清華書院第一階段錄取報到", "startDate": "2025-07-18T12:00:00", "endDate": "2025-07-24T23:59:00", "category": "Housing", "targetAudience": "第一階段錄取清華書院之新生", "details": "錄取者須完成線上報到，逾期視同放棄。", "responsibleUnit": "清華書院 / 分機:62559" },
          { "id": "online-reg-non-exam", "title": "網路報到(非分發入學)", "startDate": "2025-08-01T10:00:00", "endDate": "2025-08-07T23:59:59", "category": "Registration", "targetAudience": "特殊選才、繁星推薦、申請入學等非分發入學之新生。", "details": "上網核對基本資料、填寫其他資料並上傳高中畢業證書。未於期限內完成填寫者，學生證將不顯示英文姓名。[校務資訊系統/新生報到](https://www.ccxp.nthu.edu.tw/ccxp/INQUIRE/)", "responsibleUnit": "註冊組 / 分機:31390" },
          { "id": "fee-reduction", "title": "辦理學雜費減免", "startDate": "2025-08-13T00:00:00", "endDate": "2025-08-19T23:59:59", "category": "Financial", "targetAudience": "符合身障、原住民、低收/中低收入戶等資格之學生。", "details": "請至校務資訊系統/學雜費減免作業填寫列印申請表，並線上繳件。", "responsibleUnit": "生輔組 / 分機:34649" },
          { "id": "online-reg-exam", "title": "網路報到(分發入學)", "startDate": "2025-08-14T10:00:00", "endDate": "2025-08-18T23:59:59", "category": "Registration", "targetAudience": "分發入學之新生。", "details": "上網核對基本資料、填寫其他資料並上傳高中畢業證書。未於期限內完成填寫者，學生證將不顯示英文姓名。[校務資訊系統/新生報到](https://www.ccxp.nthu.edu.tw/ccxp/INQUIRE/)", "responsibleUnit": "註冊組 / 分機:31390" },
          { "id": "dorm-application", "title": "申請宿舍", "startDate": "2025-08-15T16:00:00", "endDate": "2025-08-18T10:00:00", "category": "Housing", "targetAudience": "全體大一新生 (未錄取書院者)。", "details": "凡未辦理網路登記住宿申請者視同放棄住宿。[學生宿舍規則](https://sthousing.site.nthu.edu.tw/p/406-1254-105021,r1559.php?Lang=zh-tw)", "responsibleUnit": "住宿組 / 分機:34706" },
          { "id": "course-selection-1", "title": "新生選課(第一階段)", "startDate": "2025-08-18T12:00:00", "endDate": "2025-08-20T09:00:00", "category": "Academic", "targetAudience": "全體大一新生", "details": "網路開放時間為每日中午12:00至次日上午09:00止。可於此階段加選【開箱清華園】微學分課程。", "responsibleUnit": "課務組 / 分機:31393-5" },
          { "id": "print-payment-bill", "title": "列印學雜費繳費單", "startDate": "2025-08-21T00:00:00", "endDate": "2025-09-01T23:59:59", "category": "Financial", "targetAudience": "全體大一新生", "details": "請同學至校務資訊系統/新生報到自行列印。辦理保留入學、休學及就學貸款同學，請勿繳費。", "responsibleUnit": "出納組 / 分機:31364" },
          { "id": "credit-waiver", "title": "辦理學分抵免", "startDate": "2025-08-01T00:00:00", "endDate": "2025-08-22T23:59:59", "category": "Academic", "targetAudience": "重考生、重新申請入學之新生等符合資格者。", "details": "務必於8月22日(五)前辦理。至「校務資訊系統」→「抵免學分」申請。", "responsibleUnit": "註冊組 / 分機:31390" },
          { "id": "student-loan-online", "title": "就學貸款(學校系統登錄)", "startDate": "2025-08-21T09:00:00", "endDate": "2025-09-01T16:00:00", "category": "Financial", "targetAudience": "欲申請就學貸款之學生。", "details": "需先至臺灣銀行各分行辦理對保手續。再至校務資訊系統/就學貸款登錄申請資料。", "responsibleUnit": "生輔組 / 分機:34660" },
          { "id": "dorm-check-in", "title": "宿舍入住", "startDate": "2025-08-24T08:30:00", "endDate": "2025-08-25T16:00:00", "category": "Housing", "targetAudience": "全體住宿新生。", "details": "至各新生齋舍報到。[學生宿舍規則](https://sthousing.site.nthu.edu.tw/p/406-1254-105021,r1559.php?Lang=zh-tw)", "responsibleUnit": "住宿組 / 分機:34706" },
          { "id": "orientation-camp", "title": "新生領航營", "startDate": "2025-08-26T00:00:00", "endDate": "2025-08-27T23:59:59", "category": "Activity", "targetAudience": "全體大一新生", "details": "詳細資訊請參閱[新生資訊網](https://www.nthu-freshmen.com/)。", "responsibleUnit": "生輔組 / 分機:34647" },
          { "id": "health-check", "title": "新生健康檢查", "startDate": "2025-08-27T08:00:00", "endDate": "2025-08-27T17:00:00", "category": "Registration", "targetAudience": "全體大一新生", "details": "健檢日為8月27日，請依註冊程序單所訂時間至校友體育館健檢。未完成健檢導致無法完成註冊程序者，須自負相關之責。", "responsibleUnit": "衛生保健組 / 分機:43000" },
          { "id": "student-loan-submit", "title": "就學貸款資料繳件", "startDate": "2025-08-29T09:00:00", "endDate": "2025-09-01T16:00:00", "category": "Financial", "targetAudience": "已完成線上登錄之就學貸款申請者。", "details": "攜帶就學貸款申請表、臺灣銀行撥款通知書第2聯等文件至水木生活中心二樓生輔組會議室繳件。", "responsibleUnit": "生輔組 / 分機:34660" },
          { "id": "tuition-payment", "title": "繳交學雜費", "startDate": "2025-08-21T00:00:00", "endDate": "2025-09-01T23:59:59", "category": "Financial", "targetAudience": "全體大一新生 (未辦理學貸、休學者)。", "details": "學生應於本校行事曆規定之上課開始日(含)前繳交各項應繳費用。繳費完成後即完成註冊。", "responsibleUnit": "出納組 / 分機:31364" },
          { "id": "class-start", "title": "正式上課日", "startDate": "2025-09-01T08:00:00", "endDate": "2025-09-01T23:59:59", "category": "Academic", "targetAudience": "全體大一新生", "details": "9月1日(星期一)開始上課。", "responsibleUnit": "教務處" },
          { "id": "parents-symposium", "title": "新生家長座談會", "startDate": "2025-08-24T14:00:00", "endDate": "2025-08-24T16:00:00", "category": "Activity", "targetAudience": "新生家長",  "details": "歡迎各位學生家長蒞臨，深入了解學校的學習環境和生活設施。地點：校本部旺宏館國際會議廳", "responsibleUnit": "生輔組 / 分機:34647 "}
        ].map(e => ({
            ...e,
            startDate: new Date(e.startDate),
            endDate: new Date(e.endDate)
        }));

        const CATEGORY_STYLES = {
            Registration: { name: '註冊', color: 'var(--cat-registration)' },
            Academic: { name: '學業', color: 'var(--cat-academic)' },
            Housing: { name: '住宿', color: 'var(--cat-housing)' },
            Financial: { name: '財務', color: 'var(--cat-financial)' },
            Activity: { name: '活動', color: 'var(--cat-activity)' },
        };

        let currentDate = new Date(); // Set a fixed date for consistent output
        let doneTasks = {};

        const app = document.getElementById('app');

        function saveDoneTasks() {
            localStorage.setItem('doneTasks', JSON.stringify(doneTasks));
        }

        function loadDoneTasks() {
            doneTasks = JSON.parse(localStorage.getItem('doneTasks')) || {};
        }

        function toUTCDate(date) {
            const d = new Date(date);
            return new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
        }

        function formatDate(date) {
            return date.toISOString().substring(0, 10);
        }

        function formatDisplayDate(date) {
            const d = new Date(date);
            return `${d.getFullYear()}/${String(d.getMonth() + 1).padStart(2, '0')}/${String(d.getDate()).padStart(2, '0')}`;
        }

        function formatTime(date) {
            const d = new Date(date);
            return `${String(d.getHours()).padStart(2, '0')}:${String(d.getMinutes()).padStart(2, '0')}`;
        }

        function render() {
            loadDoneTasks();
            app.innerHTML = `
                <header>
                    <h1>國立清華大學 114學年度新生註冊時程<br><a href="https://registra.site.nthu.edu.tw/p/406-1211-288857,r219.php?Lang=zh-tw">（詳情請見清大註冊組）</a> <a href="https://registra.site.nthu.edu.tw/var/file/211/1211/img/2979/557596209.pdf">（資料來源PDF檔）</a></h1>
                    <p>※實際日程請以清大官方公告為準，本網站資料皆為作者自行整理，不負任何相關責任※</p>
                </header>
                <main>
                    <aside class="overview-section">
                        <h2 id="overview-title"></h2>
                        <ul class="overview-list" id="overview-list"></ul>
                    </aside>
                    <section class="calendar-section">
                        <div class="calendar-controls">
                            <button id="prev-month-btn">‹</button>
                            <h2 id="current-month-year"></h2>
                            <button id="next-month-btn">›</button>
                        </div>
                        <div class="calendar-container">
                            <div class="calendar-grid" id="calendar-grid"></div>
                            <div id="event-layer"></div>
                        </div>
                        <div class="calendar-legend" id="calendar-legend"></div>
                    </section>
                </main>
                <div class="modal-overlay" id="event-modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3 id="modal-title"></h3>
                            <button class="modal-close-btn" id="modal-close-btn">&times;</button>
                        </div>
                        <div class="modal-body" id="modal-body"></div>
                    </div>
                </div>
                <footer>© 2025 清大新生註冊事件一覽表. Made by KUAN HSUN & Gemini</footer>
            `;
            renderOverview();
            renderCalendar();
            renderLegend();
            addEventListeners();
        }

        function renderOverview() {
            const displayDate = new Date(); 
            document.getElementById('overview-title').textContent = `今天 (${formatDisplayDate(displayDate)}) 的待辦事項`;

            const todaysEvents = eventData.filter(event => {
                const start = new Date(event.startDate.toDateString());
                const end = new Date(event.endDate.toDateString());
                end.setHours(23, 59, 59, 999);
                return displayDate >= start && displayDate <= end;
            });

            const overviewList = document.getElementById('overview-list');
            if (todaysEvents.length === 0) {
                overviewList.innerHTML = '<li>今天沒有待辦事項，請查看月曆以規劃未來行程。</li>';
                return;
            }

            overviewList.innerHTML = todaysEvents.map(event => `
                <li class="overview-item ${doneTasks[event.id] ? 'done' : ''}" data-id="${event.id}">
                    <input type="checkbox" data-id="${event.id}" ${doneTasks[event.id] ? 'checked' : ''}>
                    <span class="item-title">${event.title}</span>
                    <span class="category-tag" style="background-color: ${CATEGORY_STYLES[event.category]?.color || '#6c757d'}">
                        ${CATEGORY_STYLES[event.category]?.name || event.category}
                    </span>
                </li>
            `).join('');
        }

        function renderCalendar() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();

            document.getElementById('current-month-year').textContent = `${year}年 ${month + 1}月`;

            const calendarGrid = document.getElementById('calendar-grid');
            calendarGrid.innerHTML = '';

            // Headers
            ['日', '一', '二', '三', '四', '五', '六'].forEach(day => {
                calendarGrid.innerHTML += `<div class="calendar-header">${day}</div>`;
            });

            const firstDayOfMonth = new Date(year, month, 1);
            const lastDayOfMonth = new Date(year, month + 1, 0);
            
            const firstDateInView = toUTCDate(new Date(firstDayOfMonth.setDate(firstDayOfMonth.getDate() - firstDayOfMonth.getDay())));
            firstDayOfMonth.setDate(1); // Reset date

            const lastDateInView = toUTCDate(new Date(lastDayOfMonth.setDate(lastDayOfMonth.getDate() + (6 - lastDayOfMonth.getDay()))));
            lastDayOfMonth.setDate(lastDayOfMonth.getDate() - (6 - lastDayOfMonth.getDay())); // Reset date

            let tempDate = new Date(firstDateInView);
            while(tempDate <= lastDateInView) {
                const isToday = formatDate(tempDate) === formatDate(toUTCDate(new Date()));
                const isOtherMonth = tempDate.getUTCMonth() !== month;
                calendarGrid.innerHTML += `
                    <div class="calendar-day ${isToday ? 'today' : ''} ${isOtherMonth ? 'other-month' : ''}" data-date="${formatDate(tempDate)}">
                        <div class="day-number">${tempDate.getUTCDate()}</div>
                        <div class="dots-container"></div>
                    </div>
                `;
                tempDate.setUTCDate(tempDate.getUTCDate() + 1);
            }
            
            renderEventsInCalendar(year, month, firstDateInView);
        }
        
        function renderEventsInCalendar(year, month, firstDateInView) {
            const eventLayer = document.getElementById('event-layer');
            const calendarGrid = document.getElementById('calendar-grid');
            if (!eventLayer || !calendarGrid) return;
            eventLayer.innerHTML = '';

            if (window.innerWidth <= 480) {
                renderDotsForMobile(year, month);
                return;
            }

            // --- Phase 1: Calculate Layout --- //
            const monthStart = toUTCDate(new Date(year, month, 1));
            const monthEnd = toUTCDate(new Date(year, month + 1, 0));

            const visibleEvents = eventData
                .filter(event => {
                    const eventEnd = toUTCDate(event.endDate);
                    return toUTCDate(event.startDate) <= monthEnd && eventEnd >= monthStart;
                })
                .sort((a, b) => (b.endDate - b.startDate) - (a.endDate - a.startDate));

            const layout = {}; // key: date string, value: array of slots (event.id)
            const eventLayoutInfo = []; // To store calculated info for rendering

            visibleEvents.forEach(event => {
                const eventStart = toUTCDate(event.startDate);
                const eventEnd = toUTCDate(event.endDate);

                let chunkStartDate = new Date(eventStart);
                while(chunkStartDate <= eventEnd) {
                    if (chunkStartDate.getUTCMonth() > month && chunkStartDate.getUTCFullYear() >= year) break;
                    if (chunkStartDate.getUTCDay() === 0 || chunkStartDate.getTime() === eventStart.getTime()) {
                        let chunkEndDate = new Date(chunkStartDate);
                        while(chunkEndDate.getUTCDay() < 6 && chunkEndDate < eventEnd) {
                            chunkEndDate.setUTCDate(chunkEndDate.getUTCDate() + 1);
                        }

                        if (chunkEndDate.getUTCMonth() === month || chunkStartDate.getUTCMonth() === month) {
                            let slot = 0;
                            let slotFound = false;
                            while(!slotFound) {
                                let isSlotAvailable = true;
                                let dateIterator = new Date(chunkStartDate);
                                while(dateIterator <= chunkEndDate) {
                                    const dateKey = formatDate(dateIterator);
                                    if(layout[dateKey] && layout[dateKey][slot]) {
                                        isSlotAvailable = false;
                                        break;
                                    }
                                    dateIterator.setUTCDate(dateIterator.getUTCDate() + 1);
                                }
                                if(isSlotAvailable) {
                                    slotFound = true;
                                } else {
                                    slot++;
                                }
                            }

                            let dateMarker = new Date(chunkStartDate);
                            while(dateMarker <= chunkEndDate) {
                                const dateKey = formatDate(dateMarker);
                                if(!layout[dateKey]) layout[dateKey] = [];
                                layout[dateKey][slot] = event.id;
                                dateMarker.setUTCDate(dateMarker.getUTCDate() + 1);
                            }
                            eventLayoutInfo.push({ event, slot, chunkStartDate, chunkEndDate });
                        }
                        chunkStartDate = new Date(chunkEndDate);
                    }
                    chunkStartDate.setUTCDate(chunkStartDate.getUTCDate() + 1);
                }
            });

            // --- Phase 2: Apply styles and Render --- //
            const dayElements = Array.from(document.querySelectorAll('.calendar-day'));
            const headerHeight = document.querySelector('.calendar-header').offsetHeight;
            const eventBarHeight = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--event-bar-height'));
            const eventBarMargin = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--event-bar-v-margin'));
            const totalEventHeight = eventBarHeight + eventBarMargin;

            const weekMaxSlots = [0,0,0,0,0,0];
            for(const dateKey in layout) {
                const date = toUTCDate(dateKey);
                const dayIndex = Math.round((date.getTime() - firstDateInView.getTime()) / (1000 * 3600 * 24));
                const weekIndex = Math.floor(dayIndex / 7);
                if(layout[dateKey] && layout[dateKey].length > weekMaxSlots[weekIndex]) {
                    weekMaxSlots[weekIndex] = layout[dateKey].length;
                }
            }

            const gridRowHeights = weekMaxSlots.map(maxSlots => 30 + (maxSlots * totalEventHeight) + 5);
            calendarGrid.style.gridTemplateRows = `auto ${gridRowHeights.map(h => `${h}px`).join(' ')}`;

            eventLayoutInfo.forEach(({ event, slot, chunkStartDate, chunkEndDate }) => {
                const startDayOfWeek = chunkStartDate.getUTCDay();
                const dayIndex = Math.round((chunkStartDate.getTime() - firstDateInView.getTime()) / (1000 * 3600 * 24));
                const weekIndex = Math.floor(dayIndex / 7);

                const eventBar = document.createElement('div');
                eventBar.className = `event-bar ${doneTasks[event.id] ? 'done' : ''}`;
                eventBar.dataset.id = event.id;
                eventBar.textContent = event.title;
                eventBar.style.backgroundColor = CATEGORY_STYLES[event.category]?.color || '#6c757d';
                
                let top = headerHeight + (weekIndex * 1); // 1 for grid gap
                for(let i=0; i<weekIndex; i++) top += gridRowHeights[i];
                top += (slot * totalEventHeight) + 30; // 30 for day number padding

                eventBar.style.top = `${top}px`;

                const duration = (chunkEndDate.getTime() - chunkStartDate.getTime()) / (1000 * 3600 * 24) + 1;
                eventBar.style.left = `calc(${(100 / 7) * startDayOfWeek}% + 2px)`;
                eventBar.style.width = `calc(${(100 / 7) * duration}% - 4px)`;

                if (formatDate(toUTCDate(event.startDate)) === formatDate(chunkStartDate) || chunkStartDate.getUTCDay() === 0) {
                    eventBar.classList.add('start-cap');
                }
                if (formatDate(toUTCDate(event.endDate)) === formatDate(chunkEndDate) || chunkEndDate.getUTCDay() === 6) {
                    eventBar.classList.add('end-cap');
                }

                eventLayer.appendChild(eventBar);
            });
        }

        function renderDotsForMobile(year, month) {
            const visibleEvents = eventData.filter(event => {
                const eventEnd = new Date(event.endDate);
                eventEnd.setHours(23, 59, 59, 999);
                return event.startDate <= new Date(year, month + 1, 0) && eventEnd >= new Date(year, month, 1);
            });

            visibleEvents.forEach(event => {
                let iterDate = new Date(event.startDate);
                while (iterDate <= event.endDate) {
                    if (iterDate.getMonth() === month) {
                        const dayCell = document.querySelector(`.calendar-day[data-date="${formatDate(toUTCDate(iterDate))}"]`);
                        if (dayCell && !dayCell.querySelector(`.dots-container [data-id="${event.id}"]`)) {
                            const dotContainer = dayCell.querySelector('.dots-container');
                            const eventDot = document.createElement('div');
                            eventDot.className = 'event-dot';
                            eventDot.style.backgroundColor = CATEGORY_STYLES[event.category]?.color || '#6c757d';
                            eventDot.dataset.id = event.id;
                            dotContainer.appendChild(eventDot);
                        }
                    }
                    iterDate.setDate(iterDate.getDate() + 1);
                }
            });
        }

        function renderLegend() {
            const legendContainer = document.getElementById('calendar-legend');
            legendContainer.innerHTML = Object.values(CATEGORY_STYLES).map(style => `
                <div class="legend-item">
                    <div class="legend-color-box" style="background-color: ${style.color};"></div>
                    <span>${style.name}</span>
                </div>
            `).join('');
        }


        function showModal(eventId) {
            const event = eventData.find(e => e.id === eventId);
            if (!event) return;

            const detailsHtml = event.details.replace(/\[(.*?)\]\((.*?)\)/g, '<a style="color:blue;" href="$2" target="_blank" rel="noopener noreferrer"││>$1</a>');
            document.getElementById('modal-title').textContent = event.title;
            document.getElementById('modal-body').innerHTML = `
                <p><strong>辦理期間:</strong> ${formatDisplayDate(event.startDate)} ${formatTime(event.startDate)} - ${formatDisplayDate(event.endDate)} ${formatTime(event.endDate)}</p>
                <p><strong>適用對象:</strong> ${event.targetAudience}</p>
                <p><strong>重要說明:</strong> ${detailsHtml}</p>
                <p><strong>負責單位:</strong> ${event.responsibleUnit}</p>
            `;
            document.getElementById('event-modal').classList.add('visible');
        }

        function closeModal() {
            document.getElementById('event-modal').classList.remove('visible');
        }

        function toggleDone(eventId) {
            doneTasks[eventId] = !doneTasks[eventId];
            saveDoneTasks();
            renderOverview();
            renderCalendar();
        }

        function addEventListeners() {
            document.getElementById('prev-month-btn').addEventListener('click', () => {
                currentDate.setMonth(currentDate.getMonth() - 1);
                renderCalendar();
            });

            document.getElementById('next-month-btn').addEventListener('click', () => {
                currentDate.setMonth(currentDate.getMonth() + 1);
                renderCalendar();
            });

            document.getElementById('modal-close-btn').addEventListener('click', closeModal);
            document.getElementById('event-modal').addEventListener('click', (e) => {
                if (e.target === e.currentTarget) closeModal();
            });

            app.addEventListener('click', (e) => {
                const eventTarget = e.target.closest('.event-bar, .event-dot, .overview-item');
                if (eventTarget) {
                    if (e.target.matches('input[type="checkbox"]')) return;
                    showModal(eventTarget.dataset.id);
                }
            });
            
            app.addEventListener('change', (e) => {
                if (e.target.matches('input[type="checkbox"]')) {
                    toggleDone(e.target.dataset.id);
                }
            });
            
            let resizeTimer;
            window.addEventListener('resize', () => {
                clearTimeout(resizeTimer);
                resizeTimer = setTimeout(() => {
                    renderCalendar();
                }, 250);
            });
        }

        document.addEventListener('DOMContentLoaded', render);
        setTimeout(() => {
            renderOverview();
            renderCalendar();
        }, 10);

    </script>
</body>
</html>




