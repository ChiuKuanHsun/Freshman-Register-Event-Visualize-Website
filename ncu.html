<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>國立中央大學114學年度新生註冊時程</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* --- New Styles from index.html --- */
        :root {
            --color-primary: #53267F;
            --color-text: #333;
            --color-background: #f8f9fa;
            --color-light-gray: #e9ecef;
            --color-white: #fff;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.05);
            --shadow-md: 0 4px 8px rgba(0,0,0,0.1);
            --border-radius: 4px;
            --event-bar-height: 22px;
            --event-bar-v-margin: 2px;

            --cat-registration: #007bff;
            --cat-academic: #28a745;
            --cat-housing: #fd7e14;
            --cat-financial: #dc3545;
            --cat-reduction: #fd46c9;
            --cat-activity: #17a2b8;
        }
        header {
            text-align: center;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--color-light-gray);
            margin-bottom: 1.2rem;
        }
        body {
            font-family: 'Noto Sans TC', 'system-ui', sans-serif;
            background-color: var(--color-background);
            color: var(--color-text);
            line-height: 1.6;
        }

        .main-container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        /* Layout for the new calendar view */
        #calendar-view-content {
            display: grid;
            grid-template-columns: 1fr;
            gap: 2rem;
            margin-top: 2rem;
            margin-left: auto;
            margin-right: auto;
            max-width: 1200px;
        }

        @media (min-width: 992px) {
            #calendar-view-content {
                grid-template-columns: 300px 1fr;
            }
        }

        .overview-section, .calendar-section {
            background: var(--color-white);
            padding: 1.5rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-sm);
        }

        .calendar-section {
            position: relative;
        }

        .overview-section h2, .calendar-section h2 {
            font-size: 1.5rem;
            margin-top: 0;
            color: var(--color-primary);
        }

        /* Overview Section */
        .overview-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .overview-item {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
            cursor: pointer;
            transition: opacity 0.3s ease;
        }
        
        .overview-item.done {
            opacity: 0.5;
        }
        
        .overview-item.done .item-title {
            text-decoration: line-through;
        }

        .overview-item input[type="checkbox"] {
            margin-right: 0.75rem;
            min-width: 16px;
            height: 16px;
        }

        .item-title {
            flex-grow: 1;
            font-size: 0.95rem;
        }

        .category-tag {
            padding: 0.2em 0.6em;
            border-radius: var(--border-radius);
            color: var(--color-white);
            font-size: 0.75rem;
            white-space: nowrap;
        }

        /* Calendar Section */
        .calendar-container {
            position: relative;
        }

        .calendar-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .calendar-controls button {
            background: none;
            border: 1px solid var(--color-light-gray);
            border-radius: var(--border-radius);
            padding: 0.5rem 1rem;
            cursor: pointer;
            font-size: 1.2rem;
            transition: background-color 0.2s ease;
        }

        .calendar-controls button:hover {
            background-color: var(--color-light-gray);
        }

        #current-month-year {
            font-size: 1.4rem;
            font-weight: bold;
            color: var(--color-primary);
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            grid-auto-rows: 1fr;
            gap: 1px;
            position: relative;
            background-color: var(--color-light-gray);
            border: 1px solid var(--color-light-gray);
        }

        .calendar-header {
            text-align: center;
            font-weight: bold;
            color: var(--color-primary);
            padding: 0.5rem 0;
            background-color: var(--color-white);
        }

        .calendar-day {
            background-color: #fff;
            position: relative;
            padding: 4px;
            padding-top: 30px;
            min-height: 120px;
            box-sizing: border-box;
        }
        
        .calendar-day.other-month {
            background-color: #fdfdff;
        }

        .calendar-day.other-month .day-number {
            opacity: 0.4;
        }

        .day-number {
            position: absolute;
            top: 5px;
            right: 5px;
            font-size: 0.85rem;
            z-index: 2;
        }
        
        .calendar-day.today .day-number {
            background-color: var(--color-primary);
            color: var(--color-white);
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
        }

        #event-layer {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
        }

        .event-bar {
            font-size: 0.75rem;
            padding: 0 8px;
            color: white;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            cursor: pointer;
            position: absolute;
            height: var(--event-bar-height);
            line-height: var(--event-bar-height);
            box-sizing: border-box;
            pointer-events: auto;
            transition: opacity 0.3s ease;
        }

        .event-bar.start-cap {
            border-top-left-radius: var(--border-radius);
            border-bottom-left-radius: var(--border-radius);
            border-top-right-radius: var(--border-radius);
            border-bottom-right-radius: var(--border-radius);
        }

        .event-bar.end-cap {
            border-top-right-radius: var(--border-radius);
            border-bottom-right-radius: var(--border-radius);
            border-top-left-radius: var(--border-radius);
            border-bottom-left-radius: var(--border-radius);
        }
        
        .event-bar:hover {
            opacity: 0.8;
            z-index: 3;
        }
        
        .event-bar.done {
            opacity: 0.5;
            text-decoration: line-through;
        }

        .calendar-legend {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 1rem;
            margin-top: 2rem;
            padding-top: 1rem;
            border-top: 1px solid var(--color-light-gray);
        }

        .legend-item {
            display: flex;
            align-items: center;
            font-size: 0.85rem;
        }

        .legend-color-box {
            width: 16px;
            height: 16px;
            border-radius: var(--border-radius);
            margin-right: 0.5rem;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
            z-index: 1000;
        }

        .modal-overlay.visible {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: var(--color-white);
            padding: 2rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-md);
            width: 90%;
            max-width: 600px;
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }
        
        .modal-overlay.visible .modal-content {
            transform: scale(1);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--color-light-gray);
            padding-bottom: 1rem;
            margin-bottom: 1rem;
        }

        .modal-header h3 {
            margin: 0;
            font-size: 1.5rem;
            color: var(--color-primary);
        }

        .modal-close-btn {
            background: none;
            border: none;
            font-size: 2rem;
            cursor: pointer;
            line-height: 1;
        }
        
        .modal-body p {
            margin: 0 0 1rem 0;
        }
        
        .modal-body strong {
            color: var(--color-primary);
            margin-right: 0.5rem;
        }

        .modal-body a {
            color: var(--color-primary);
            text-decoration: none;
            font-weight: 500;
        }

        .modal-body a:hover {
            text-decoration: underline;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .event-bar { font-size: 0.7rem; height: 20px; line-height: 20px; }
            .calendar-header { font-size: 0.8rem; }
            .modal-content { padding: 1.5rem; }
            .modal-header h3 { font-size: 1.3rem; }
        }
        
        @media (max-width: 480px) {
            #calendar-view-content { grid-template-columns: 1fr; }
            .calendar-grid { gap: 1px; }
            .calendar-day { min-height: 80px; padding-top: 25px; }
            .day-number { font-size: 0.75rem; }
            .event-bar { display: none; } /* Hide event text on very small screens */
            .dots-container { 
                position: absolute;
                bottom: 4px;
                left: 0;
                right: 0;
                text-align: center;
            }
            .event-dot { /* Show a dot instead */
                display: inline-block;
                width: 8px;
                height: 8px;
                border-radius: 50%;
                margin: 0 1px;
            }
        }

        /* --- Styles for Full List View (Untouched) --- */
        .completed {
            opacity: 0.5;
        }
        .completed .task-title {
            text-decoration: line-through;
        }
        .task-details {
            transition: max-height 0.5s ease-in-out, padding 0.5s ease-in-out;
            max-height: 0;
            overflow: hidden;
        }
        .task-details.open {
            max-height: 1000px;
        }

    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div class="main-container container mx-auto p-4 md:p-8">
        <header>
            <h1 class="text-2xl md:text-3xl font-bold text-[var(--color-primary)]">國立中央大學114學年度新生註冊時程<br><a href="https://pdc.adm.ncu.edu.tw/newble_note.asp" target="_blank" style="text-decoration: underline; color: #007bff; font-size: large;">（詳情請見中央大學註冊組）</a> <a href="https://pdc.adm.ncu.edu.tw/Register/data/college/114/underHB.pdf" target="_blank" style="text-decoration: underline; color: #007bff; font-size: large;">（資料來源PDF檔）</a></h1>
            <p class="text-gray-500 mt-2">※請使用電腦進行瀏覽，如使用手機請將手機轉成橫的※ </p>
            <p class="text-gray-500 mt-2">※免責聲明：實際日程請以中央大學官方公告和PDF為準，本網站資料為由AI讀取PDF後整理產生，不負任何相關責任※ </p>
 
        </header>

        <!-- View Switcher (Untouched) -->
        <div class="flex justify-center mb-8 bg-gray-200 rounded-lg p-1 max-w-sm mx-auto">
            <button id="btn-calendar-view" class="w-1/2 p-2 rounded-md text-sm font-medium focus:outline-none transition-colors duration-300">日曆模式</button>
            <button id="btn-list-view" class="w-1/2 p-2 rounded-md text-sm font-medium focus:outline-none transition-colors duration-300">完整列表模式</button>
        </div>

        <!-- Calendar View (Replaced) -->
        <div id="calendar-view">
            <div id="calendar-view-content">
                <aside class="overview-section">
                    <h2 id="overview-title" class="text-2xl md:text-3xl font-bold text-[var(--color-primary)]"></h2><br>
                    <ul class="overview-list" id="overview-list"></ul>
                </aside>
                <section class="calendar-section">
                    <div class="calendar-controls">
                        <button id="prev-month-btn">‹</button>
                        <h2 id="current-month-year"></h2>
                        <button id="next-month-btn">›</button>
                    </div>
                    <div class="calendar-container">
                        <div class="calendar-grid" id="calendar-grid"></div>
                        <div id="event-layer"></div>
                    </div>
                    <div class="calendar-legend" id="calendar-legend"></div>
                </section>
            </div>
            <div class="modal-overlay" id="event-modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3 id="modal-title"></h3>
                        <button class="modal-close-btn" id="modal-close-btn">&times;</button>
                    </div>
                    <div class="modal-body" id="modal-body"></div>
                </div>
            </div>
        </div>

        <!-- Full List View (Untouched) -->
        <div id="list-view" class="hidden" style="max-width: 1200px; margin-left: auto; margin-right: auto;">
             <div class="mb-6">
                <input type="search" id="search-box" placeholder="搜尋待辦事項 (例如：宿舍、免修)..." class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#a38db8] focus:border-[#53267F] transition">
            </div>
            <div id="list-container" class="space-y-8">
                <!-- Task categories and items will be injected here by original JS -->
            </div>
        </div>
        <footer style="font-size: small; margin-top: 10px; margin-bottom: -20px;">© 2025 國立中央大學114學年度新生註冊時程一覽表. Made by KUAN HSUN & Gemini</footer>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- DATA (SHARED) ---
        const eventsData = [
    {
        "id": "ncu-fee-reduction",
        "title": "辦理學雜費減免",
        "startDate": "2025-08-01T00:00:00",
        "endDate": "2025-08-28T12:00:00",
        "category": "Reduction",
        "targetAudience": "符合減免資格之學生",
        "details": "請至本校首頁Portal入口之「就學輔助系統」登錄申請，並將證明文件繳交至生活輔導組。",
        "responsibleUnit": "生活輔導組 / 分機:57222"
    },
    {
        "id": "ncu-document-submission",
        "title": "繳交學歷證件、身分證件影本",
        "startDate": "2025-08-01T00:00:00",
        "endDate": "2025-08-29T23:59:59",
        "category": "Registration",
        "targetAudience": "全體新生",
        "details": "於大一新生週期間，將高中學歷證件影本、身分證影本訂妥，並註明姓名、系別及學號，交由班代彙送註冊組。",
        "responsibleUnit": "註冊組 / 分機:57115-57118, 57122-57125"
    },
    {
        "id": "ncu-student-loan",
        "title": "辦理就學貸款",
        "startDate": "2025-08-01T00:00:00",
        "endDate": "2025-09-03T23:59:59",
        "category": "Financial",
        "targetAudience": "欲申請就學貸款之學生",
        "details": "請至\"[臺灣銀行網站](https://sloan.bot.com.tw/sloan/sLoanLogin.do)\"登錄並列印申請書，至臺銀各分行對保後，將撥款通知書第二聯交至生活輔導組。",
        "responsibleUnit": "生活輔導組 / 分機:57222"
    },
    {
        "id": "ncu-external-health-check",
        "title": "繳交校外體檢資料表",
        "startDate": "2025-08-01T00:00:00",
        "endDate": "2025-09-09T23:59:59",
        "category": "Registration",
        "targetAudience": "無法參加校內體檢之新生",
        "details": "若無法參加校內新生體檢，請自行至醫療院所完成檢查，並於期限前將健康資料表繳交或寄達至衛保組。",
        "responsibleUnit": "衛生保健組 / 分機:57217"
    },
    {
        "id": "ncu-delayed-registration",
        "title": "申請延緩註冊",
        "startDate": "2025-08-01T00:00:00",
        "endDate": "2025-09-12T23:59:59",
        "category": "Registration",
        "targetAudience": "因故需延緩註冊之學生",
        "details": "請填寫\"[延緩註冊申請表](https://pdc.adm.ncu.edu.tw/form_reg.asp)\"並經系所主管簽章後送至註冊組。",
        "responsibleUnit": "註冊組 / 分機:57115-57118, 57122-57125"
    },
    {
        "id": "ncu-off-campus-housing",
        "title": "校外賃居資料登錄",
        "startDate": "2025-08-01T00:00:00",
        "endDate": "2025-09-12T23:59:59",
        "category": "Housing",
        "targetAudience": "校外租屋學生",
        "details": "有校外租屋同學，需至Portal系統輸入校外租屋地址。可參考\"[生活輔導組外宿資訊網](https://house.nfu.edu.tw/NCU)\"提供之租屋資訊。",
        "responsibleUnit": "生活輔導組 / 分機:57212"
    },
    {
        "id": "ncu-military-service",
        "title": "兵役資料登錄",
        "startDate": "2025-08-01T00:00:00",
        "endDate": "2025-09-20T23:59:59",
        "category": "Registration",
        "targetAudience": "本國籍男生",
        "details": "請至本校portal入口之學籍登錄系統填寫兵役資料。相關說明請參考\"[兵役說明網頁](https://military.ncu.edu.tw/military_service.php)\"。",
        "responsibleUnit": "生活輔導組 / 分機:57220"
    },
    {
        "id": "ncu-dorm-application-1",
        "title": "宿舍申請(申請、繁星等管道新生)",
        "startDate": "2025-08-11T00:00:00",
        "endDate": "2025-08-19T12:00:00",
        "category": "Housing",
        "targetAudience": "申請入學、繁星等管道之新生",
        "details": "大一新生保障住宿。有住宿意願者，請至Portal之宿舍申請系統登記。",
        "responsibleUnit": "住宿服務組 / 分機:57282, 57290"
    },
    {
        "id": "ncu-career-course",
        "title": "新生週：生涯發展指引線上課程",
        "startDate": "2025-08-18T00:00:00",
        "endDate": "2025-08-21T23:59:59",
        "category": "Activity",
        "targetAudience": "全體新生",
        "details": "新生須參加生涯發展指引線上課程，各系場次請見\"[活動網頁](https://tinyurl.com/mpsejyxa)\"。",
        "responsibleUnit": "職涯發展中心 / 分機:57241"
    },
    {
        "id": "ncu-dorm-application-2",
        "title": "宿舍申請(分科測驗新生)",
        "startDate": "2025-08-18T00:00:00",
        "endDate": "2025-08-19T12:00:00",
        "category": "Housing",
        "targetAudience": "分科測驗入學之新生",
        "details": "大一新生保障住宿。請於完成學籍登錄後，至Portal之宿舍申請系統登記。",
        "responsibleUnit": "住宿服務組 / 分機:57282, 57290"
    },
    {
        "id": "ncu-reserve-admission",
        "title": "申請保留入學資格",
        "startDate": "2025-08-18T00:00:00",
        "endDate": "2025-08-29T23:59:59",
        "category": "Academic",
        "targetAudience": "符合資格之新生",
        "details": "須符合本校學則規定並持有相關證明方可申請。請先完成學籍資料登錄後洽註冊組辦理。",
        "responsibleUnit": "註冊組 / 分機:57115-57118, 57122-57125"
    },
    {
        "id": "ncu-tuition-payment",
        "title": "繳交學雜費",
        "startDate": "2025-08-22T00:00:00",
        "endDate": "2025-08-31T23:59:59",
        "category": "Financial",
        "targetAudience": "全體新生",
        "details": "可於8/22起至本校Portal或\"[第一銀行第e學雜費入口網](https://eschool.firstbank.com.tw/)\"下載繳費單。",
        "responsibleUnit": "出納組 / 分機:57346"
    },
    {
        "id": "ncu-english-placement-test",
        "title": "大一英文分級測驗",
        "startDate": "2025-08-25T00:00:00",
        "endDate": "2025-08-26T23:59:59",
        "category": "Academic",
        "targetAudience": "無學測英文成績之非英文系新生",
        "details": "無學測成績的非英文系新生及復學生，請擇一日下午14:00至綜教館0-114教室參加測驗，無須事先報名。",
        "responsibleUnit": "語言中心 / 分機:33816"
    },
    {
        "id": "ncu-safety-education",
        "title": "新生週：校園安全教育宣導",
        "startDate": "2025-08-25T00:00:00",
        "endDate": "2025-08-25T23:59:59",
        "category": "Activity",
        "targetAudience": "全體新生",
        "details": "新生校園安全教育宣導活動。",
        "responsibleUnit": "生輔組(校安) / 分機:57212"
    },
    {
        "id": "ncu-learning-passport-briefing",
        "title": "新生週：學生學習護照線上說明會",
        "startDate": "2025-08-26T00:00:00",
        "endDate": "2025-08-26T23:59:59",
        "category": "Activity",
        "targetAudience": "全體新生",
        "details": "線上會議連結請參考新生知訊網或服學資訊網公告。",
        "responsibleUnit": "服務學習發展中心 / 分機:57229"
    },
    {
        "id": "ncu-course-selection",
        "title": "新生選課",
        "startDate": "2025-08-27T00:00:00",
        "endDate": "2025-09-10T23:59:59",
        "category": "Academic",
        "targetAudience": "全體新生",
        "details": "登入選課系統進行選課。選課期間系統定於每日早上7:00-9:00進行資料備份，請避開此時段。",
        "responsibleUnit": "課務組 / 分機:57166-57171"
    },
    {
        "id": "ncu-freshman-camp",
        "title": "新生週：大一新生營",
        "startDate": "2025-08-27T00:00:00",
        "endDate": "2025-08-27T23:59:59",
        "category": "Activity",
        "targetAudience": "全體新生",
        "details": "於大禮堂舉行，活動相關資訊請參考新生知訊網。",
        "responsibleUnit": "課外活動組 / 分機:57231"
    },
    {
        "id": "ncu-health-check",
        "title": "新生健康檢查",
        "startDate": "2025-08-28T00:00:00",
        "endDate": "2025-08-29T23:59:59",
        "category": "Registration",
        "targetAudience": "全體新生",
        "details": "於依仁堂舉行，請務必全員參加。檢查注意事項及排程請至\"[新生知訊網](http://ncufresh.ncu.edu.tw/)\"查詢。",
        "responsibleUnit": "衛生保健組 / 分機:57217"
    },
    {
        "id": "ncu-mental-health-lecture",
        "title": "新生週：新生心理適應講座",
        "startDate": "2025-08-28T00:00:00",
        "endDate": "2025-08-28T23:59:59",
        "category": "Activity",
        "targetAudience": "全體新生",
        "details": "活動相關資訊請參考新生知訊網。",
        "responsibleUnit": "諮商中心 / 分機:57263"
    },
    {
        "id": "ncu-club-expo",
        "title": "新生週：社團博覽會",
        "startDate": "2025-08-30T00:00:00",
        "endDate": "2025-08-30T23:59:59",
        "category": "Activity",
        "targetAudience": "全體新生",
        "details": "於教研大樓廣場舉行，活動相關資訊請參考新生知訊網。",
        "responsibleUnit": "課外活動組 / 分機:57231"
    },
    {
        "id": "ncu-student-id-pickup",
        "title": "班代領取學生證",
        "startDate": "2025-09-01T00:00:00",
        "endDate": "2025-09-12T23:59:59",
        "category": "Registration",
        "targetAudience": "全體新生",
        "details": "學生完成註冊程序後，請各班班代表或系辦派人至註冊組領取。",
        "responsibleUnit": "註冊組 / 分機:57115-57118, 57122-57125"
    },
    {
        "id": "ncu-disadvantaged-grant",
        "title": "申請弱勢學生助學計畫",
        "startDate": "2025-09-01T00:00:00",
        "endDate": "2025-10-17T23:59:59",
        "category": "Reduction",
        "targetAudience": "符合資格之學生",
        "details": "申請資格為全戶113年度收入90萬以下且財產總計650萬以下。請至Portal之就學補助系統登錄。",
        "responsibleUnit": "生活輔導組 / 分機:57220"
    },
    {
        "id": "ncu-freshman-assembly-reg",
        "title": "大一週會報名",
        "startDate": "2025-09-02T00:00:00",
        "endDate": "2025-09-20T23:59:59",
        "category": "Academic",
        "targetAudience": "大一新生",
        "details": "學生畢業前須完成4場大一週會及2場院週會。請至\"[大一週會報名系統](https://is.gd/KezZnx)\"完成報名。",
        "responsibleUnit": "學務處 / 分機:57201"
    },
    {
        "id": "ncu-manual-add-drop",
        "title": "人工加退選",
        "startDate": "2025-09-12T00:00:00",
        "endDate": "2025-09-16T23:59:59",
        "category": "Academic",
        "targetAudience": "全體學生",
        "details": "選課系統關閉後的人工加退選時間。",
        "responsibleUnit": "課務組 / 分機:57166-57171"
    },
    {
        "id": "ncu-credit-fee-payment",
        "title": "繳交學分費",
        "startDate": "2025-09-23T00:00:00",
        "endDate": "2025-10-03T23:59:59",
        "category": "Financial",
        "targetAudience": "研究生、學士班延修生等",
        "details": "修習九學分(含)以內之學士班延修生等，應於加退選結束後另行繳交學分費。",
        "responsibleUnit": "出納組 / 分機:57346"
    }
].map(e => ({...e, startDate: new Date(e.startDate), endDate: new Date(e.endDate)}));

        const fullListData = [
    {
        "category": "註冊與報到",
        "id": "ncu-email-activation",
        "isScheduled": false,
        "title": "啟用E-MAIL帳號",
        "responsibleUnit": "電算中心 / 分機:57555, 57566",
        "details": "說明:此帳號密碼為登入校內各系統（選課、宿舍申請等）的鑰匙，請務必至\"[帳號啟動介面](https://www.cc.ncu.edu.tw/p/412-1033-117.php)\"啟動並牢記。"
    },
    {
        "category": "註冊與報到",
        "id": "ncu-student-data-login",
        "isScheduled": false,
        "title": "新生學籍資料登錄",
        "responsibleUnit": "註冊組 / 諮商中心",
        "details": "開始時間:申請入學等8/11起，分科測驗及轉學生8/18起。\n說明:請至本校Portal入口登錄學籍資料，並確認英文姓名以利製作學位證書。登錄後請務必接著填寫「新生輔導需求調查表」。"
    },
    {
        "category": "註冊與報到",
        "id": "ncu-tuition-payment",
        "isScheduled": true,
        "title": "繳交學雜費",
        "responsibleUnit": "出納組 / 分機:57346",
        "details": "時間:8月22日至8月31日。\n說明:可於8/22起至本校Portal或\"[第一銀行第e學雜費入口網](https://eschool.firstbank.com.tw/)\"下載繳費單。"
    },
    {
        "category": "註冊與報到",
        "id": "ncu-document-submission",
        "isScheduled": true,
        "title": "繳交學歷及身分證件",
        "responsibleUnit": "註冊組 / 分機:57115-57118, 57122-57125",
        "details": "期限:8月29日前。\n說明:於新生週期間，將高中學歷證件影本、身分證影本訂妥後，交由班代彙送註冊組。"
    },
    {
        "category": "註冊與報到",
        "id": "ncu-military-service",
        "isScheduled": true,
        "title": "兵役資料登錄",
        "responsibleUnit": "生活輔導組 / 分機:57220",
        "details": "期限:9月20日前。\n說明:本國籍男生必填。請至Portal學籍登錄系統填寫，以免影響緩徵權益。相關說明請參考\"[兵役說明網頁](https://military.ncu.edu.tw/military_service.php)\"。"
    },
    {
        "category": "註冊與報到",
        "id": "ncu-health-check",
        "isScheduled": true,
        "title": "新生健康檢查",
        "responsibleUnit": "衛生保健組 / 分機:57217",
        "details": "時間:8月28日至8月29日。\n說明:於依仁堂舉行，請務必全員參加。若無法參加，需自行校外體檢並於9/9前繳交資料表。"
    },
    {
        "category": "註冊與報到",
        "id": "ncu-student-id-pickup",
        "isScheduled": true,
        "title": "領取學生證",
        "responsibleUnit": "註冊組 / 分機:57115-57118, 57122-57125",
        "details": "時間:9月1日至9月12日。\n說明:完成註冊程序後，由班代表統一至註冊組領取。"
    },
    {
        "category": "註冊與報到",
        "id": "ncu-delayed-registration",
        "isScheduled": true,
        "title": "申請延緩註冊",
        "responsibleUnit": "註冊組",
        "details": "期限:9月12日前。\n說明:因故需延緩註冊者，請填寫\"[延緩註冊申請表](https://pdc.adm.ncu.edu.tw/form_reg.asp)\"辦理。"
    },
    {
        "category": "學籍與課業",
        "id": "ncu-course-selection",
        "isScheduled": true,
        "title": "新生選課",
        "responsibleUnit": "課務組 / 分機:57166-57171",
        "details": "時間:8月27日至9月10日。\n說明:登入選課系統進行選課，請避開每日早上7:00-9:00的系統備份時段。"
    },
    {
        "category": "學籍與課業",
        "id": "ncu-manual-add-drop",
        "isScheduled": true,
        "title": "人工加退選",
        "responsibleUnit": "課務組 / 分機:57166-57171",
        "details": "時間:9月12日至9月16日。\n說明:選課系統關閉後的人工加退選時間。"
    },
    {
        "category": "學籍與課業",
        "id": "ncu-credit-fee-payment",
        "isScheduled": true,
        "title": "繳交學分費",
        "responsibleUnit": "出納組 / 分機:57346",
        "details": "時間:9月23日至10月3日。\n說明:研究生、選讀學分生及修習九學分(含)以內之學士班延修生，於此期間繳交學分費。"
    },
    {
        "category": "學籍與課業",
        "id": "ncu-english-placement-test",
        "isScheduled": true,
        "title": "大一英文分級測驗",
        "responsibleUnit": "語言中心 / 分機:33816",
        "details": "時間:8月25日至8月26日。\n說明:無學測英文成績的非英文系新生及復學生，請擇一日參加，無須事先報名。"
    },
    {
        "category": "學籍與課業",
        "id": "ncu-freshman-assembly-reg",
        "isScheduled": true,
        "title": "大一週會報名",
        "responsibleUnit": "學務處 / 分機:57201",
        "details": "時間:9月2日至9月20日。\n說明:畢業前須完成規定場次，請至\"[大一週會報名系統](https://is.gd/KezZnx)\"報名。"
    },
    {
        "category": "學籍與課業",
        "id": "ncu-reserve-admission",
        "isScheduled": true,
        "title": "申請保留入學資格",
        "responsibleUnit": "註冊組",
        "details": "時間:8月18日至8月29日。\n說明:須符合學則規定並持有證明，請先完成學籍登錄後再洽註冊組辦理。"
    },
    {
        "category": "學籍與課業",
        "id": "ncu-leave-of-absence",
        "isScheduled": false,
        "title": "申請休學",
        "responsibleUnit": "註冊組",
        "details": "開始時間:8月18日起。\n說明:因故申請休學者，請洽註冊組辦理。若確定開學前休學，請勿繳交學雜費。"
    },
    {
        "category": "財務與住宿",
        "id": "ncu-student-loan",
        "isScheduled": true,
        "title": "辦理就學貸款",
        "responsibleUnit": "生活輔導組 / 分機:57222",
        "details": "期限:9月3日以前。\n說明:請至\"[臺灣銀行網站](https://sloan.bot.com.tw/sloan/sLoanLogin.do)\"登錄，完成對保後將文件交至生輔組。"
    },
    {
        "category": "財務與住宿",
        "id": "ncu-fee-reduction",
        "isScheduled": true,
        "title": "辦理學雜費減免",
        "responsibleUnit": "生活輔導組 / 分機:57222",
        "details": "期限:8月28日中午以前。\n說明:請至Portal之「就學輔助系統」登錄申請。"
    },
    {
        "category": "財務與住宿",
        "id": "ncu-disadvantaged-grant",
        "isScheduled": true,
        "title": "申請弱勢學生助學計畫",
        "responsibleUnit": "生活輔導組 / 分機:57220",
        "details": "時間:9月1日至10月17日。\n說明:符合資格者請至Portal之就學補助系統登錄申請。"
    },
    {
        "category": "財務與住宿",
        "id": "ncu-dorm-application-1",
        "isScheduled": true,
        "title": "宿舍申請(申請、繁星等)",
        "responsibleUnit": "住宿服務組 / 分機:57282, 57290",
        "details": "時間:8月11日至8月19日中午。\n說明:大一新生保障住宿，請至Portal宿舍申請系統登記。"
    },
    {
        "category": "財務與住宿",
        "id": "ncu-dorm-application-2",
        "isScheduled": true,
        "title": "宿舍申請(分科測驗)",
        "responsibleUnit": "住宿服務組 / 分機:57282, 57290",
        "details": "時間:學籍登錄後至8月19日中午。\n說明:大一新生保障住宿，請至Portal宿舍申請系統登記。"
    },
    {
        "category": "財務與住宿",
        "id": "ncu-off-campus-housing",
        "isScheduled": true,
        "title": "校外賃居資料登錄",
        "responsibleUnit": "生活輔導組 / 分機:57212",
        "details": "期限:9月12日前。\n說明:校外租屋學生需至Portal系統登錄地址。可參考\"[生活輔導組外宿資訊網](https://house.nfu.edu.tw/NCU)\"。"
    },
    {
        "category": "新生週活動",
        "id": "ncu-career-course",
        "isScheduled": true,
        "title": "生涯發展指引線上課程",
        "responsibleUnit": "職涯發展中心 / 分機:57241",
        "details": "時間:8月18日至8月21日。\n說明:新生必修線上課程，各系場次請見\"[活動網頁](https://tinyurl.com/mpsejyxa)\"。"
    },
    {
        "category": "新生週活動",
        "id": "ncu-safety-education",
        "isScheduled": true,
        "title": "校園安全教育宣導",
        "responsibleUnit": "生輔組(校安) / 分機:57212",
        "details": "時間:8月25日。"
    },
    {
        "category": "新生週活動",
        "id": "ncu-learning-passport-briefing",
        "isScheduled": true,
        "title": "學生學習護照線上說明會",
        "responsibleUnit": "服務學習發展中心 / 分機:57229",
        "details": "時間:8月26日。"
    },
    {
        "category": "新生週活動",
        "id": "ncu-freshman-camp",
        "isScheduled": true,
        "title": "大一新生營",
        "responsibleUnit": "課外活動組 / 分機:57231",
        "details": "時間:8月27日。\n地點:大禮堂。"
    },
    {
        "category": "新生週活動",
        "id": "ncu-mental-health-lecture",
        "isScheduled": true,
        "title": "新生心理適應講座",
        "responsibleUnit": "諮商中心 / 分機:57263",
        "details": "時間:8月28日。"
    },
    {
        "category": "新生週活動",
        "id": "ncu-club-expo",
        "isScheduled": true,
        "title": "社團博覽會",
        "responsibleUnit": "課外活動組 / 分機:57231",
        "details": "時間:8月30日。\n地點:教研大樓廣場。"
    },
    {
        "category": "其他",
        "id": "ncu-library-activation",
        "isScheduled": false,
        "title": "啟用圖書館服務",
        "responsibleUnit": "典閱組",
        "details": "開始時間:8月26日起。\n說明:首次借書及使用圖書館服務前，請先登入Portal帳號完成簽署。"
    }
];
        const CATEGORY_STYLES = {
            Registration: { name: '註冊', color: 'var(--cat-registration)' },
            Academic: { name: '學業', color: 'var(--cat-academic)' },
            Housing: { name: '住宿', color: 'var(--cat-housing)' },
            Financial: { name: '財務', color: 'var(--cat-financial)' },
            Activity: { name: '活動', color: 'var(--cat-activity)' },
            Reduction: { name: '學費減免/優待', color: 'var(--cat-reduction)' }
        };

        // --- STATE (SHARED) ---
        let calendarDate = new Date(); // Date for the calendar view
        let completedTasks = new Set(JSON.parse(localStorage.getItem('completedTasksNTHU')) || []);
        let currentView = 'calendar';

        // --- DOM ELEMENTS (SHARED) ---
        const calendarView = document.getElementById('calendar-view');
        const listView = document.getElementById('list-view');
        const btnCalendarView = document.getElementById('btn-calendar-view');
        const btnListView = document.getElementById('btn-list-view');
        
        // --- SHARED FUNCTIONS ---
        const handleCheckboxChange = (taskId) => {
            if (completedTasks.has(taskId)) {
                completedTasks.delete(taskId);
            } else {
                completedTasks.add(taskId);
            }
            localStorage.setItem('completedTasksNTHU', JSON.stringify([...completedTasks]));
            updateView(); // Re-render the current view
        };

        // --- VIEW SWITCHING LOGIC (UNCHANGED) ---
        const switchView = (view) => {
            localStorage.setItem('View', view);
            currentView = view;
            updateView();
        };

        const updateView = () => {
            if (currentView === 'calendar') {
                btnCalendarView.classList.add('bg-[#53267F]', 'text-white');
                btnCalendarView.classList.remove('bg-transparent', 'text-gray-600');
                btnListView.classList.add('bg-transparent', 'text-gray-600');
                btnListView.classList.remove('bg-[#53267F]', 'text-white');
                calendarView.classList.remove('hidden');
                listView.classList.add('hidden');
                renderCalendarView();
            } else {
                btnListView.classList.add('bg-[#53267F]', 'text-white');
                btnListView.classList.remove('bg-transparent', 'text-gray-600');
                btnCalendarView.classList.add('bg-transparent', 'text-gray-600');
                btnCalendarView.classList.remove('bg-[#53267F]', 'text-white');
                listView.classList.remove('hidden');
                calendarView.classList.add('hidden');
                renderListView();
            }
        };

        // --- CALENDAR VIEW LOGIC (NEW) ---
        const renderCalendarView = () => {
            renderOverview();
            renderCalendar();
            renderLegend();
            addCalendarEventListeners();
        };

        const toUTCDate = (date) => new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
        const formatDate = (date) => date.toISOString().substring(0, 10);
        const formatDisplayDate = (date) => `${date.getFullYear()}/${String(date.getMonth() + 1).padStart(2, '0')}/${String(date.getDate()).padStart(2, '0')}`;
        const formatTime = (date) => `${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;

        const renderOverview = () => {
            const displayDate = new Date();
            document.getElementById('overview-title').textContent = `今天 (${formatDisplayDate(displayDate)}) 的待辦事項`;
            const todaysEvents = eventsData.filter(event => {
                const start = new Date(event.startDate.toDateString());
                const end = new Date(event.endDate.toDateString());
                end.setHours(23, 59, 59, 999);
                return displayDate >= start && displayDate <= end;
            });
            const overviewList = document.getElementById('overview-list');
            if (todaysEvents.length === 0) {
                overviewList.innerHTML = '<li>今天沒有待辦事項，請查看月曆以規劃未來行程。</li>';
                return;
            }
            overviewList.innerHTML = todaysEvents.map(event => `
                <li class="overview-item ${completedTasks.has(event.id) ? 'done' : ''}" data-id="${event.id}">
                    <input type="checkbox" data-id="${event.id}" ${completedTasks.has(event.id) ? 'checked' : ''}>
                    <span class="item-title">${event.title}</span>
                    <span class="category-tag" style="background-color: ${CATEGORY_STYLES[event.category]?.color || '#6c757d'}">
                        ${CATEGORY_STYLES[event.category]?.name || event.category}
                    </span>
                </li>
            `).join('');
        };
        
        const renderCalendar = () => {
            const year = calendarDate.getFullYear();
            const month = calendarDate.getMonth();
            document.getElementById('current-month-year').textContent = `${year}年 ${month + 1}月`;
            const calendarGrid = document.getElementById('calendar-grid');
            calendarGrid.innerHTML = '';
            ['日', '一', '二', '三', '四', '五', '六'].forEach(day => {
                calendarGrid.innerHTML += `<div class="calendar-header">${day}</div>`;
            });
            const firstDayOfMonth = new Date(year, month, 1);
            const lastDayOfMonth = new Date(year, month + 1, 0);
            const firstDateInView = toUTCDate(new Date(firstDayOfMonth.setDate(firstDayOfMonth.getDate() - firstDayOfMonth.getDay())));
            firstDayOfMonth.setDate(1);
            const lastDateInView = toUTCDate(new Date(lastDayOfMonth.setDate(lastDayOfMonth.getDate() + (6 - lastDayOfMonth.getDay()))));
            lastDayOfMonth.setDate(lastDayOfMonth.getDate() - (6 - lastDayOfMonth.getDay()));
            let tempDate = new Date(firstDateInView);
            while(tempDate <= lastDateInView) {
                const isToday = formatDate(tempDate) === formatDate(toUTCDate(new Date()));
                const isOtherMonth = tempDate.getUTCMonth() !== month;
                calendarGrid.innerHTML += `
                    <div class="calendar-day ${isToday ? 'today' : ''} ${isOtherMonth ? 'other-month' : ''}" data-date="${formatDate(tempDate)}">
                        <div class="day-number">${tempDate.getUTCDate()}</div>
                        <div class="dots-container"></div>
                    </div>
                `;
                tempDate.setUTCDate(tempDate.getUTCDate() + 1);
            }
            renderEventsInCalendar(year, month, firstDateInView);
        };

        const renderEventsInCalendar = (year, month, firstDateInView) => {
            const eventLayer = document.getElementById('event-layer');
            const calendarGrid = document.getElementById('calendar-grid');
            if (!eventLayer || !calendarGrid) return;
            eventLayer.innerHTML = '';

            if (window.innerWidth <= 480) {
                renderDotsForMobile(year, month);
                return;
            }

            const monthStart = toUTCDate(new Date(year, month, 1));
            const monthEnd = toUTCDate(new Date(year, month + 1, 0));
            const visibleEvents = eventsData.filter(event => toUTCDate(event.startDate) <= monthEnd && toUTCDate(event.endDate) >= monthStart).sort((a, b) => (b.endDate - b.startDate) - (a.endDate - a.startDate));
            const layout = {};
            const eventLayoutInfo = [];

            visibleEvents.forEach(event => {
                let chunkStartDate = new Date(event.startDate);
                while(chunkStartDate <= event.endDate) {
                    if (chunkStartDate.getMonth() > month && chunkStartDate.getFullYear() >= year) break;
                    if (chunkStartDate.getDay() === 0 || chunkStartDate.getTime() === event.startDate.getTime()) {
                        let chunkEndDate = new Date(chunkStartDate);
                        
                        // FIX: The condition now uses toUTCDate to compare dates without time,
                        // preventing the loop from running one extra time.
                        while(chunkEndDate.getDay() < 6 && toUTCDate(chunkEndDate) < toUTCDate(event.endDate)) {
                            chunkEndDate.setDate(chunkEndDate.getDate() + 1);
                        }

                        if (chunkEndDate.getMonth() === month || chunkStartDate.getMonth() === month) {
                            let slot = 0;
                            let slotFound = false;
                            while(!slotFound) {
                                let isSlotAvailable = true;
                                let dateIterator = new Date(chunkStartDate);
                                while(dateIterator <= chunkEndDate) {
                                    const dateKey = formatDate(toUTCDate(dateIterator));
                                    if(layout[dateKey] && layout[dateKey][slot]) {
                                        isSlotAvailable = false;
                                        break;
                                    }
                                    dateIterator.setDate(dateIterator.getDate() + 1);
                                }
                                if(isSlotAvailable) slotFound = true; else slot++;
                            }
                            let dateMarker = new Date(chunkStartDate);
                            while(dateMarker <= chunkEndDate) {
                                const dateKey = formatDate(toUTCDate(dateMarker));
                                if(!layout[dateKey]) layout[dateKey] = [];
                                layout[dateKey][slot] = event.id;
                                dateMarker.setDate(dateMarker.getDate() + 1);
                            }
                            eventLayoutInfo.push({ event, slot, chunkStartDate, chunkEndDate });
                        }
                        chunkStartDate = new Date(chunkEndDate);
                    }
                    chunkStartDate.setDate(chunkStartDate.getDate() + 1);
                }
            });

            const headerHeight = document.querySelector('.calendar-header').offsetHeight;
            const eventBarHeight = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--event-bar-height'));
            const eventBarMargin = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--event-bar-v-margin'));
            const totalEventHeight = eventBarHeight + eventBarMargin;
            const weekMaxSlots = [0,0,0,0,0,0];
            for(const dateKey in layout) {
                const date = toUTCDate(new Date(dateKey));
                const dayIndex = Math.round((date.getTime() - firstDateInView.getTime()) / (1000 * 3600 * 24));
                const weekIndex = Math.floor(dayIndex / 7);
                if(layout[dateKey] && layout[dateKey].length > weekMaxSlots[weekIndex]) {
                    weekMaxSlots[weekIndex] = layout[dateKey].length;
                }
            }
            const gridRowHeights = weekMaxSlots.map(maxSlots => 30 + (maxSlots * totalEventHeight) + 5);
            calendarGrid.style.gridTemplateRows = `auto ${gridRowHeights.map(h => `${h}px`).join(' ')}`;

            eventLayoutInfo.forEach(({ event, slot, chunkStartDate, chunkEndDate }) => {
                const startDayOfWeek = chunkStartDate.getDay();
                const dayIndex = Math.round((toUTCDate(chunkStartDate).getTime() - firstDateInView.getTime()) / (1000 * 3600 * 24));
                const weekIndex = Math.floor(dayIndex / 7);
                const eventBar = document.createElement('div');
                eventBar.className = `event-bar ${completedTasks.has(event.id) ? 'done' : ''}`;
                eventBar.dataset.id = event.id;
                eventBar.textContent = event.title;
                eventBar.style.backgroundColor = CATEGORY_STYLES[event.category]?.color || '#6c757d';
                let top = headerHeight + (weekIndex * 1);
                for(let i=0; i<weekIndex; i++) top += gridRowHeights[i];
                top += (slot * totalEventHeight) + 30;
                eventBar.style.top = `${top}px`;
                const duration = (toUTCDate(chunkEndDate).getTime() - toUTCDate(chunkStartDate).getTime()) / (1000 * 3600 * 24) + 1;
                eventBar.style.left = `calc(${(100 / 7) * startDayOfWeek}% + 2px)`;
                eventBar.style.width = `calc(${(100 / 7) * duration}% - 4px)`;
                if (formatDate(toUTCDate(event.startDate)) === formatDate(toUTCDate(chunkStartDate)) || chunkStartDate.getDay() === 0) eventBar.classList.add('start-cap');
                if (formatDate(toUTCDate(event.endDate)) === formatDate(toUTCDate(chunkEndDate)) || chunkEndDate.getDay() === 6) eventBar.classList.add('end-cap');
                eventLayer.appendChild(eventBar);
            });
        };

        const renderDotsForMobile = (year, month) => {
            const visibleEvents = eventsData.filter(event => {
                const eventEnd = new Date(event.endDate);
                eventEnd.setHours(23, 59, 59, 999);
                return event.startDate <= new Date(year, month + 1, 0) && eventEnd >= new Date(year, month, 1);
            });
            visibleEvents.forEach(event => {
                let iterDate = new Date(event.startDate);
                while (iterDate <= event.endDate) {
                    if (iterDate.getMonth() === month) {
                        const dayCell = document.querySelector(`.calendar-day[data-date="${formatDate(toUTCDate(iterDate))}"]`);
                        if (dayCell && !dayCell.querySelector(`.dots-container [data-id="${event.id}"]`)) {
                            const dotContainer = dayCell.querySelector('.dots-container');
                            const eventDot = document.createElement('div');
                            eventDot.className = 'event-dot';
                            eventDot.style.backgroundColor = CATEGORY_STYLES[event.category]?.color || '#6c757d';
                            eventDot.dataset.id = event.id;
                            dotContainer.appendChild(eventDot);
                        }
                    }
                    iterDate.setDate(iterDate.getDate() + 1);
                }
            });
        };

        const renderLegend = () => {
            const legendContainer = document.getElementById('calendar-legend');
            legendContainer.innerHTML = Object.values(CATEGORY_STYLES).map(style => `
                <div class="legend-item">
                    <div class="legend-color-box" style="background-color: ${style.color};"></div>
                    <span>${style.name}</span>
                </div>
            `).join('');
        };

        const showModal = (eventId) => {
            const event = eventsData.find(e => e.id === eventId);
            if (!event) return;
            const detailsHtml = event.details.replace(/\[(.*?)\]\((.*?)\)/g, '<a style="color:blue;" href="$2" target="_blank" rel="noopener noreferrer">$1</a>');
            document.getElementById('modal-title').textContent = event.title;
            document.getElementById('modal-body').innerHTML = `
                <p><strong>辦理期間:</strong> ${formatDisplayDate(event.startDate)} ${formatTime(event.startDate)} - ${formatDisplayDate(event.endDate)} ${formatTime(event.endDate)}</p>
                <p><strong>適用對象:</strong> ${event.targetAudience}</p>
                <p><strong>重要說明:</strong> ${detailsHtml}</p>
                <p><strong>負責單位:</strong> ${event.responsibleUnit}</p>
            `;
            document.getElementById('event-modal').classList.add('visible');
        };

        const closeModal = () => document.getElementById('event-modal').classList.remove('visible');
        
        const addCalendarEventListeners = () => {
            const calendarViewNode = document.getElementById('calendar-view');
            if (calendarViewNode.dataset.listenersAttached) return;

            document.getElementById('prev-month-btn').addEventListener('click', () => {
                calendarDate.setMonth(calendarDate.getMonth() - 1);
                renderCalendar();
            });
            document.getElementById('next-month-btn').addEventListener('click', () => {
                calendarDate.setMonth(calendarDate.getMonth() + 1);
                renderCalendar();
            });
            document.getElementById('modal-close-btn').addEventListener('click', closeModal);
            document.getElementById('event-modal').addEventListener('click', (e) => {
                if (e.target === e.currentTarget) closeModal();
            });
            calendarViewNode.addEventListener('click', (e) => {
                const eventTarget = e.target.closest('.event-bar, .event-dot, .overview-item');
                if (eventTarget) {
                    if (e.target.matches('input[type="checkbox"]')) return;
                    showModal(eventTarget.dataset.id);
                }
            });
            calendarViewNode.addEventListener('change', (e) => {
                if (e.target.matches('input[type="checkbox"]')) {
                    handleCheckboxChange(e.target.dataset.id);
                }
            });
            let resizeTimer;
            window.addEventListener('resize', () => {
                clearTimeout(resizeTimer);
                resizeTimer = setTimeout(() => {
                    if(currentView === 'calendar') renderCalendar();
                }, 250);
            });
            calendarViewNode.dataset.listenersAttached = 'true';
        };

        // --- LIST VIEW LOGIC (UNCHANGED) ---
        const renderListView = () => {
            const listContainer = document.getElementById('list-container');
            const searchBox = document.getElementById('search-box');
            listContainer.innerHTML = '';
            const searchTerm = searchBox.value.toLowerCase();
            const groupedData = fullListData.reduce((acc, item) => {
                const category = item.category;
                if (!acc[category]) acc[category] = [];
                acc[category].push(item);
                return acc;
            }, {});
            for (const category in groupedData) {
                const categoryContainer = document.createElement('div');
                categoryContainer.innerHTML = `<h2 class="text-2xl font-bold text-[#53267F] border-b-2 border-[#a38db8] pb-2 mb-4">${category}</h2>`;
                const itemsList = document.createElement('div');
                itemsList.className = 'space-y-4';
                let hasVisibleItems = false;
                groupedData[category].forEach(item => {
                    const itemText = (item.title + item.details + item.responsibleUnit).toLowerCase();
                    if (itemText.includes(searchTerm)) {
                        const taskCard = createTaskCard(item);
                        itemsList.appendChild(taskCard);
                        hasVisibleItems = true;
                    }
                });
                if (hasVisibleItems) {
                    categoryContainer.appendChild(itemsList);
                    listContainer.appendChild(categoryContainer);
                }
            }
        };

        const createTaskCard = (item) => {
            const isCompleted = completedTasks.has(item.id);
            const card = document.createElement('div');
            card.className = `task-item bg-white p-4 rounded-lg shadow-sm border border-gray-200 transition-opacity ${isCompleted ? 'completed' : ''}`;
            const header = document.createElement('div');
            header.className = 'task-header flex flex-col sm:flex-row sm:items-center sm:justify-between';
            const leftSection = document.createElement('div');
            leftSection.className = 'flex-grow mb-2 sm:mb-0';
            const checkboxLabel = document.createElement('label');
            checkboxLabel.className = 'flex items-center space-x-3 cursor-pointer';
            checkboxLabel.innerHTML = `
                <input type="checkbox" ${isCompleted ? 'checked' : ''} class="h-5 w-5 rounded border-gray-300 text-[#53267F] focus:ring-[#a38db8] flex-shrink-0">
                <span class="task-title text-lg font-semibold text-gray-800">${item.title}</span>`;
            checkboxLabel.querySelector('input').addEventListener('change', () => handleCheckboxChange(item.id));
            leftSection.appendChild(checkboxLabel);
            const unit = document.createElement('p');
            unit.className = 'text-sm text-gray-500 ml-8';
            unit.textContent = item.responsibleUnit;
            leftSection.appendChild(unit);
            const rightSection = document.createElement('div');
            rightSection.className = 'flex-shrink-0 self-start sm:self-center';
            const toggleButton = document.createElement('button');
            toggleButton.className = 'toggle-details text-sm font-medium text-[#53267F] hover:underline flex items-center';
            toggleButton.innerHTML = `<span class="btn-text">[+] 查看說明</span>`;
            rightSection.appendChild(toggleButton);
            header.appendChild(leftSection);
            header.appendChild(rightSection);
            const details = document.createElement('div');
            details.className = 'task-details mt-2 pl-8';
            const detailsHtml = item.details.replace(/\[(.*?)\]\((.*?)\)/g, '<a style="color:blue;" href="$2" target="_blank" rel="noopener noreferrer">$1</a>');
            details.innerHTML = `<div class="bg-gray-50 p-4 rounded-md border text-gray-600 whitespace-pre-wrap">${detailsHtml}</div>`;
            toggleButton.addEventListener('click', () => {
                details.classList.toggle('open');
                const btnText = toggleButton.querySelector('.btn-text');
                btnText.textContent = details.classList.contains('open') ? '[-] 收合說明' : '[+] 查看說明';
            });
            card.appendChild(header);
            card.appendChild(details);
            return card;
        };
        
        // --- APP INITIALIZATION ---
        const init = () => {
            // Setup listeners for non-view-specific elements
            btnCalendarView.addEventListener('click', () => switchView('calendar'))
            btnListView.addEventListener('click', () => switchView('list'));
            document.getElementById('search-box').addEventListener('input', renderListView);
            // Initial view render
            updateView();
        };
        
        init();
        switchView(localStorage.getItem('View')||'calendar');
        setTimeout(() => {
            renderOverview();
            renderCalendar();
        }, 10);
    });
    </script>
</body>
</html>
